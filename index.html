import React, { useState, useEffect, useRef } from "react";
import { motion } from "framer-motion";
import {
  LineChart,
  Line,
  CartesianGrid,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
} from "recharts";

// --- Animated Orb Component (for Login Page) ---
const Orb = ({ className, initial, animate }) => (
  <motion.div
    className={`absolute rounded-full filter blur-3xl opacity-40 ${className}`}
    initial={initial}
    animate={animate}
    transition={{
      duration: Math.random() * 8 + 10,
      repeat: Infinity,
      repeatType: 'mirror',
      ease: 'easeInOut',
    }}
  />
);

// --- Login Page Component ---
const LoginPage = ({ onLoginSuccess }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [isLoggingIn, setIsLoggingIn] = useState(false);
  const [isSignUp, setIsSignUp] = useState(false);
  const [error, setError] = useState("");
  const [isForgotPassword, setIsForgotPassword] = useState(false);
  const [resetEmailSent, setResetEmailSent] = useState(false);
  const [showPassword, setShowPassword] = useState(false);


  const containerVariants = {
    hidden: { opacity: 0 },
    visible: { opacity: 1, transition: { staggerChildren: 0.2 } },
  };

  const itemVariants = {
    hidden: { y: 20, opacity: 0 },
    visible: { y: 0, opacity: 1, transition: { type: 'spring', stiffness: 100 } },
  };
  
  const handleLoginSubmit = (e) => {
    e.preventDefault();
    setError(""); // Clear previous errors
    setIsLoggingIn(true);

    // Simulate database using localStorage
    const users = JSON.parse(localStorage.getItem('auraUsers')) || {};

    if (isSignUp) {
        // --- Sign Up Logic ---
        if (users[email]) {
            setError("User already exists. Please sign in.");
            setIsLoggingIn(false);
            return;
        }
        // In a real app, you would hash the password
        users[email] = { password: password };
        localStorage.setItem('auraUsers', JSON.stringify(users));
        setTimeout(() => onLoginSuccess(email), 1000);

    } else {
        // --- Sign In Logic ---
        if (users[email] && users[email].password === password) {
            setTimeout(() => onLoginSuccess(email), 1000);
        } else {
            setTimeout(() => {
                setError("Invalid email or password.");
                setIsLoggingIn(false);
            }, 1000);
        }
    }
  };

  const handleForgotPasswordSubmit = (e) => {
    e.preventDefault();
    setError("");
    setIsLoggingIn(true); // Re-use for loading state
    
    // In a real app, you would check if the user exists and send an email.
    // Here we just simulate the process for a better user experience.
    console.log(`Password reset requested for: ${email}`);
    
    setTimeout(() => {
        setResetEmailSent(true);
        setIsLoggingIn(false);
    }, 1500);
  };
  
  if (isForgotPassword) {
      return (
        <div className="relative min-h-screen bg-gradient-to-br from-gray-900 to-indigo-900 overflow-hidden flex items-center justify-center p-4 font-sans">
          <Orb className="w-96 h-96 bg-indigo-500" initial={{ x: -100, y: -150 }} animate={{ x: 100, y: 150 }} />
          <Orb className="w-80 h-80 bg-pink-500" initial={{ x: 200, y: 150 }} animate={{ x: -50, y: -200 }} />
          <Orb className="w-72 h-72 bg-purple-500" initial={{ x: -200, y: 200 }} animate={{ x: 50, y: -100 }} />
          <motion.div
            className="relative z-10 w-full max-w-md p-8 space-y-6 bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl"
            initial={{ opacity: 0, y:20 }}
            animate={{ opacity: 1, y:0 }}
          >
              {resetEmailSent ? (
                <div className="text-center">
                    <h2 className="text-3xl font-bold text-white">Check Your Email</h2>
                    <p className="text-indigo-200 mt-2">A password reset link has been sent to {email} if an account with that email exists.</p>
                    <button onClick={() => {setIsForgotPassword(false); setResetEmailSent(false); setEmail('');}} className="mt-6 w-full py-3 font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">
                        Back to Login
                    </button>
                </div>
              ) : (
                <>
                    <div className="text-center">
                      <h2 className="text-3xl font-bold text-white">Reset Password</h2>
                      <p className="text-indigo-200 mt-2">Enter your email to receive a reset link.</p>
                    </div>

                    <form onSubmit={handleForgotPasswordSubmit} className="space-y-6">
                        <div className="relative">
                            <label htmlFor="email" className="absolute -top-2.5 left-3 px-1 text-xs text-indigo-200 bg-gray-800 rounded">Email Address</label>
                            <input id="email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="you@example.com" className="w-full px-4 py-3 bg-white/5 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" required />
                        </div>
                        
                        <div>
                            <motion.button type="submit" className="w-full py-3 font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 disabled:opacity-50" disabled={isLoggingIn}>
                                {isLoggingIn ? "Sending..." : "Send Reset Link"}
                            </motion.button>
                        </div>
                    </form>

                    <p className="text-center text-sm text-gray-400">
                        Remember your password?
                        <button onClick={() => { setIsForgotPassword(false); setError(""); }} className="ml-2 font-medium text-indigo-400 hover:text-indigo-300 transition bg-transparent border-none cursor-pointer">
                            Back to Login
                        </button>
                    </p>
                </>
              )}
          </motion.div>
        </div>
      )
  }

  return (
    <div className="relative min-h-screen bg-gradient-to-br from-gray-900 to-indigo-900 overflow-hidden flex items-center justify-center p-4 font-sans">
      <Orb className="w-96 h-96 bg-indigo-500" initial={{ x: -100, y: -150 }} animate={{ x: 100, y: 150 }} />
      <Orb className="w-80 h-80 bg-pink-500" initial={{ x: 200, y: 150 }} animate={{ x: -50, y: -200 }} />
      <Orb className="w-72 h-72 bg-purple-500" initial={{ x: -200, y: 200 }} animate={{ x: 50, y: -100 }} />
      
      <motion.div
        className="relative z-10 w-full max-w-md p-8 space-y-6 bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl"
        variants={containerVariants}
        initial="hidden"
        animate="visible"
      >
        <motion.div variants={itemVariants} className="text-center">
          <h2 className="text-4xl font-bold text-white">{isSignUp ? "Create Account" : "Welcome To AURA"}</h2>
          <p className="text-indigo-200 mt-2">{isSignUp ? "Join Aura to start your journey." : "Sign in to access your world."}</p>
        </motion.div>

        {error && (
            <motion.div initial={{opacity: 0}} animate={{opacity: 1}} className="p-3 bg-red-500/30 border border-red-500/50 text-red-200 text-center rounded-lg">
                {error}
            </motion.div>
        )}

        <form onSubmit={handleLoginSubmit} className="space-y-6">
            <motion.div variants={itemVariants} className="relative group">
                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-indigo-300 group-focus-within:text-indigo-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                </span>
                <input id="email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Email Address" className="w-full pl-10 pr-4 py-3 bg-white/5 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" required />
            </motion.div>

            <motion.div variants={itemVariants} className="relative group">
                 <span className="absolute left-3 top-1/2 -translate-y-1/2 text-indigo-300 group-focus-within:text-indigo-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                 </span>
                <input id="password" type={showPassword ? "text" : "password"} value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Password" className="w-full pl-10 pr-10 py-3 bg-white/5 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" required />
                <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-1/2 -translate-y-1/2 text-indigo-300 hover:text-indigo-200">
                    {showPassword ? (
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                    ) : (
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    )}
                </button>
            </motion.div>
          
          <motion.div variants={itemVariants} className="flex items-center justify-end text-sm">
             {!isSignUp && <button type="button" onClick={() => setIsForgotPassword(true)} className="font-medium text-indigo-400 hover:text-indigo-300 transition bg-transparent border-none">Forgot Password?</button>}
          </motion.div>
          
          <motion.div variants={itemVariants}>
            <motion.button type="submit" className="w-full py-3 font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-indigo-500 transition-all disabled:opacity-50" whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }} disabled={isLoggingIn}>
              {isLoggingIn ? "Please wait..." : (isSignUp ? "Sign Up" : "Sign In")}
            </motion.button>
          </motion.div>
        </form>
        
        <motion.p variants={itemVariants} className="text-center text-sm text-gray-400">
            {isSignUp ? "Already have an account?" : "Don't have an account?"}
            <button onClick={() => { setIsSignUp(!isSignUp); setError(""); }} className="ml-2 font-medium text-indigo-400 hover:text-indigo-300 transition bg-transparent border-none cursor-pointer">
                {isSignUp ? "Sign In" : "Sign Up"}
            </button>
        </motion.p>
      </motion.div>
    </div>
  );
};

// --- Onboarding Form Component ---
const OnboardingForm = ({ onOnboardingComplete, userEmail }) => {
    const [formData, setFormData] = useState({ name: "", gender: "", phone: "", age: "", address: "" });
    const [isLoading, setIsLoading] = useState(false);

    const handleChange = (e) => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        setIsLoading(true);

        const onboardingData = JSON.parse(localStorage.getItem('auraOnboarding')) || {};
        onboardingData[userEmail] = {
            completed: true,
            ...formData
        };
        localStorage.setItem('auraOnboarding', JSON.stringify(onboardingData));

        setTimeout(() => {
            onOnboardingComplete(formData);
        }, 1000);
    };

    return (
        <div className="relative min-h-screen bg-gradient-to-br from-gray-900 to-indigo-900 overflow-hidden flex items-center justify-center p-4 font-sans">
            <Orb className="w-96 h-96 bg-indigo-500" initial={{ x: -100, y: -150 }} animate={{ x: 100, y: 150 }} />
            <Orb className="w-80 h-80 bg-pink-500" initial={{ x: 200, y: 150 }} animate={{ x: -50, y: -200 }} />
            <motion.div
                className="relative z-10 w-full max-w-md p-8 space-y-6 bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl"
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
            >
                <div className="text-center">
                    <h2 className="text-4xl font-bold text-white">Tell Us About Yourself</h2>
                    <p className="text-indigo-200 mt-2">This helps us personalize your experience.</p>
                </div>

                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="text-sm text-indigo-200">Name</label>
                        <input type="text" name="name" value={formData.name} onChange={handleChange} className="w-full mt-1 px-4 py-3 bg-white/5 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" required />
                    </div>
                    <div>
                        <label className="text-sm text-indigo-200">Gender</label>
                        <select name="gender" value={formData.gender} onChange={handleChange} className="w-full mt-1 px-4 py-3 bg-white/5 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                            <option value="">Select...</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="non-binary">Non-binary</option>
                            <option value="prefer-not-to-say">Prefer not to say</option>
                        </select>
                    </div>
                     <div>
                        <label className="text-sm text-indigo-200">Age</label>
                        <input type="number" name="age" value={formData.age} onChange={handleChange} className="w-full mt-1 px-4 py-3 bg-white/5 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" required />
                    </div>
                     <div>
                        <label className="text-sm text-indigo-200">Phone Number</label>
                        <input type="tel" name="phone" value={formData.phone} onChange={handleChange} className="w-full mt-1 px-4 py-3 bg-white/5 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" />
                    </div>
                     <div>
                        <label className="text-sm text-indigo-200">Address</label>
                        <textarea name="address" value={formData.address} onChange={handleChange} rows="2" className="w-full mt-1 px-4 py-3 bg-white/5 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"></textarea>
                    </div>
                    
                    <motion.button type="submit" className="w-full py-3 font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 disabled:opacity-50" disabled={isLoading}>
                        {isLoading ? "Saving..." : "Continue to Aura"}
                    </motion.button>
                </form>
            </motion.div>
        </div>
    );
};


// --- Wellness App Component ---
const WellnessApp = ({ userEmail, initialProfileData }) => {
  const [screen, setScreen] = useState(null);
  const [chat, setChat] = useState([
    { id: Date.now(), from: "bot", text: "Hi â€” I'm Aura, your confidential wellness companion. How are you feeling today? You can chat with me, or select an activity from the left." },
  ]);
  const [input, setInput] = useState("");
  const [isThinking, setIsThinking] = useState(false);
  const [escalationOpen, setEscalationOpen] = useState(false);
  const [isConnecting, setIsConnecting] = useState(false);
  const [streak, setStreak] = useState(0);
  const [journalEntries, setJournalEntries] = useState([]);
  const [newJournal, setNewJournal] = useState("");
  const [journalInsight, setJournalInsight] = useState(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [isGeneratingPrompt, setIsGeneratingPrompt] = useState(false);
  const [peerStories, setPeerStories] = useState([
      {id: 1, text: "â€œI used to feel alone with my anxiety until I shared it. Now I know itâ€™s okay to seek help.â€"},
      {id: 2, text: "â€œJournaling helped me reduce my stress before exams. I realized I wasnâ€™t weak for asking for help.â€"}
  ]);
  const [isGeneratingStory, setIsGeneratingStory] = useState(false);
  const [isSharingStory, setIsSharingStory] = useState(false);
  const [newStoryText, setNewStoryText] = useState("");
  const [achievements, setAchievements] = useState([
    { id: 1, title: "First Check-in", earned: true, category: "Consistency", description: "You started your journey by checking in for the first time." },
    { id: 2, title: "3-Day Streak", earned: true, category: "Consistency", description: "Keep it up! You've checked in for three consecutive days." },
    { id: 3, title: "Shared a Journal Entry", earned: false, category: "Self-Expression", description: "You've opened up and shared your thoughts in the journal." },
    { id: 4, title: "Completed a Habit", earned: true, category: "Mindfulness", description: "You took a small step towards building a positive habit." },
  ]);
  const [habits, setHabits] = useState([
    { id: 1, name: "Drink water", completed: false },
    { id: 2, name: "5 min meditation", completed: false },
    { id: 3, name: "Gratitude note", completed: true },
  ]);
  const [isSuggestingHabit, setIsSuggestingHabit] = useState(false);
  const [moodHistory, setMoodHistory] = useState([
    { day: "Mon", mood: 2 }, { day: "Tue", mood: 3 }, { day: "Wed", mood: 1 }, { day: "Thu", mood: 2 }, { day: "Fri", mood: 4 },
  ]);
  const [isAnalyzingTrend, setIsAnalyzingTrend] = useState(false);
  const [moodTrendAnalysis, setMoodTrendAnalysis] = useState("");
  const [suggestions, setSuggestions] = useState([]);
  const [isGettingSuggestions, setIsGettingSuggestions] = useState(false);
  const [feedbackText, setFeedbackText] = useState("");
  const [feedbackSent, setFeedbackSent] = useState(false);
  const [profilePhoto, setProfilePhoto] = useState(null);
  const fileInputRef = useRef(null);
  const [profileData, setProfileData] = useState(initialProfileData);
  const [isEditingProfile, setIsEditingProfile] = useState(false);
  const [editedProfile, setEditedProfile] = useState(profileData);
  const [currentPassword, setCurrentPassword] = useState("");
  const [newPassword, setNewPassword] = useState("");
  const [isListening, setIsListening] = useState(false);
  const recognitionRef = useRef(null);


  const chatEndRef = useRef(null);

  // --- Streak Logic ---
  useEffect(() => {
    const getTodayDateString = () => {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    const todayStr = getTodayDateString();
    const streakData = JSON.parse(localStorage.getItem('auraStreakData'));
    
    let currentStreak = 1;

    if (streakData) {
        const lastLoginDate = new Date(streakData.lastLogin);
        const today = new Date(todayStr);
        lastLoginDate.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);
        const diffTime = today.getTime() - lastLoginDate.getTime();
        const diffDays = Math.round(diffTime / (1000 * 3600 * 24));
        if (diffDays === 0) {
            currentStreak = streakData.count;
        } else if (diffDays === 1) {
            currentStreak = streakData.count + 1;
        } else {
            currentStreak = 1;
        }
    }
    setStreak(currentStreak);
    localStorage.setItem('auraStreakData', JSON.stringify({ count: currentStreak, lastLogin: todayStr }));
  }, []);

  // --- Speech Recognition Logic ---
  useEffect(() => {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        recognitionRef.current = new SpeechRecognition();
        const recognition = recognitionRef.current;
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onstart = () => setIsListening(true);
        recognition.onend = () => setIsListening(false);
        recognition.onerror = (event) => {
            console.error("Speech recognition error:", event.error);
            setIsListening(false);
        };
        
        recognition.onresult = (event) => {
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript;
                }
            }
            if (finalTranscript) {
              setInput(prevInput => prevInput + finalTranscript + ' ');
            }
        };
    } else {
        console.warn("Speech Recognition not supported by this browser.");
    }
  }, []);

  const handleToggleListening = () => {
    const recognition = recognitionRef.current;
    if (!recognition) return;

    if (isListening) {
        recognition.stop();
    } else {
        recognition.start();
    }
  };


  const API_KEY = "";
  const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
  
  const callGeminiAPI = async (prompt, retries = 3, delay = 1000) => {
    try {
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: { parts: [{ text: "You are Aura, a compassionate and supportive wellness companion for young people. Your tone is gentle, encouraging, and non-judgmental. You are not a therapist, but a helpful guide. Keep your responses concise (2-3 sentences). Suggest in-app activities like journaling, habit tracking, or mood insights when relevant." }] },
        };
        const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
        const result = await response.json();
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!text) throw new Error("No text found in API response.");
        return text;
    } catch (error) {
        console.error("Gemini API call error:", error);
        if (retries > 0) {
            await new Promise(res => setTimeout(res, delay));
            return callGeminiAPI(prompt, retries - 1, delay * 2);
        }
        return "I'm having a little trouble thinking right now. Please try again in a moment.";
    }
  };

  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [chat]);

  async function sendMessage() {
    if (!input.trim() || isThinking) return;
    const userMsg = { id: Date.now(), from: "user", text: input.trim() };
    setChat((c) => [...c, userMsg]);
    setInput("");
    setIsThinking(true);
    const lowered = userMsg.text.toLowerCase();
    if (lowered.includes("suicid") || lowered.includes("kill myself") || lowered.includes("want to die")) {
        const botText = "I'm really sorry youâ€™re feeling this way. I need to pause and make sure you stay safe. Can I connect you to a crisis line in your area or to a trusted person?";
        setChat((c) => [...c, { id: Date.now() + 1, from: 'bot', text: botText }]);
        setIsConnecting(false);
        setEscalationOpen(true);
        setIsThinking(false);
        return;
    }
    const chatHistory = chat.map(m => `${m.from}: ${m.text}`).join('\n');
    const prompt = `Current conversation:\n${chatHistory}\n\nuser: ${userMsg.text}\nbot:`;
    const botText = await callGeminiAPI(prompt);
    setChat((c) => [...c, { id: Date.now() + 1, from: "bot", text: botText }]);
    setIsThinking(false);
  }

  async function getJournalInsights() {
      if (isAnalyzing || journalEntries.length === 0) return;
      setIsAnalyzing(true);
      setJournalInsight(null);
      const lastEntry = journalEntries[journalEntries.length - 1].text;
      const prompt = `A user wrote this journal entry: "${lastEntry}". Act as a compassionate wellness companion. Do not give medical advice. Provide a short, gentle summary of the entry and ask one open-ended, reflective question to help them explore their feelings. Format it as: "Summary: [Your summary]\n\nReflection: [Your question]"`;
      const insight = await callGeminiAPI(prompt);
      setJournalInsight(insight);
      setIsAnalyzing(false);
  }

  async function generatePeerStory() {
      if(isGeneratingStory) return;
      setIsGeneratingStory(true);
      const prompt = "Write a short (2-3 sentences), anonymous, hopeful story from the perspective of a young person who has overcome a mental wellness challenge (like anxiety, stress, or sadness) and is in a better place now. The story should be encouraging and focus on the positive outcome of seeking help or using coping strategies.";
      const newStoryText = await callGeminiAPI(prompt);
      setPeerStories(prev => [{ id: Date.now(), text: newStoryText }, ...prev]);
      setIsGeneratingStory(false);
  }

  async function suggestNewHabit() {
    if(isSuggestingHabit) return;
    setIsSuggestingHabit(true);
    const prompt = "Suggest one simple, actionable daily habit for a young person focused on mental wellness. The habit should be short and easy to accomplish, like 'Drink a glass of water after waking up' or 'Stretch for 5 minutes'. Return only the habit text itself, without any introductory phrases.";
    const newHabitText = await callGeminiAPI(prompt);
    if (newHabitText && !habits.some(h => h.name === newHabitText)) {
        setHabits(prev => [...prev, { id: Date.now(), name: newHabitText, completed: false }]);
    }
    setIsSuggestingHabit(false);
  }

  async function generateJournalPrompt() {
    if(isGeneratingPrompt) return;
    setIsGeneratingPrompt(true);
    const prompt = "Generate a single, gentle, and reflective journal prompt for a young person looking to explore their feelings. Keep it open-ended. For example: 'What is something small that brought you a bit of joy today?' or 'If you could give your younger self one piece of advice, what would it be?'. Return only the prompt text itself.";
    const newPrompt = await callGeminiAPI(prompt);
    setNewJournal(prev => `${prev}${prev ? '\n\n' : ''}${newPrompt} `);
    setIsGeneratingPrompt(false);
  }

  async function analyzeMoodTrend() {
    if(isAnalyzingTrend) return;
    setIsAnalyzingTrend(true);
    setMoodTrendAnalysis("");
    const trendString = moodHistory.map(d => `${d.day}: ${moodLabels[d.mood]}`).join(', ');
    const prompt = `A user's mood trend for the last few days was: ${trendString}. Act as a compassionate wellness companion. Briefly and gently comment on this pattern in 1-2 sentences. Do not give medical advice. If you see improvement, acknowledge it. If the mood is consistently low, offer encouragement and gently suggest an in-app activity like journaling or a breathing exercise.`;
    const analysis = await callGeminiAPI(prompt);
    setMoodTrendAnalysis(analysis);
    setIsAnalyzingTrend(false);
  }

  async function getSuggestions() {
    if(isGettingSuggestions) return;
    setIsGettingSuggestions(true);
    setSuggestions([]);
    const trendString = moodHistory.map(d => `${d.day}: ${moodLabels[d.mood]}`).join(', ');
    const lastEntry = journalEntries.length > 0 ? journalEntries[journalEntries.length - 1].text : "No entry provided.";
    const prompt = `Based on the following user data:\n- Recent Moods: ${trendString}\n- Last Journal Entry: "${lastEntry}"\n\nPlease generate 2-3 personalized, actionable wellness suggestions. Return the response as a valid JSON array of objects, where each object has a 'suggestion' key with the text and an 'icon' key with a relevant emoji. For example: [{'icon': 'ðŸš¶', 'suggestion': 'Since you mentioned feeling stressed, a short 10-minute walk outside could help clear your mind.'}]`;
    
    try {
        const responseText = await callGeminiAPI(prompt);
        // Clean the response text to ensure it's valid JSON
        const cleanJson = responseText.replace(/```json|```/g, '').trim();
        const parsedSuggestions = JSON.parse(cleanJson);
        setSuggestions(parsedSuggestions);
    } catch (error) {
        console.error("Failed to parse suggestions:", error);
        setSuggestions([{ icon: 'âš ï¸', suggestion: "I had a little trouble generating suggestions right now. Maybe try a breathing exercise or a short walk?" }]);
    }
    
    setIsGettingSuggestions(false);
  }

  function handleSendFeedback() {
    if (!feedbackText.trim()) {
        alert("Please enter your feedback before sending.");
        return;
    }
    setFeedbackText("");
    setFeedbackSent(true);
    setTimeout(() => {
        setFeedbackSent(false);
    }, 4000);
  }

  const handlePhotoUpload = (event) => {
    const file = event.target.files[0];
    if (file) {
        setProfilePhoto(URL.createObjectURL(file));
    }
  };

  const handleProfileEdit = () => {
    setEditedProfile(profileData);
    setIsEditingProfile(true);
  };

  const handleProfileCancel = () => {
    setIsEditingProfile(false);
  };

  const handleProfileSave = () => {
    setProfileData(editedProfile);
    if (currentPassword && newPassword) {
        // In a real app, you'd verify the current password before updating
        const users = JSON.parse(localStorage.getItem('auraUsers')) || {};
        if (users[userEmail] && users[userEmail].password === currentPassword) {
            users[userEmail].password = newPassword;
            localStorage.setItem('auraUsers', JSON.stringify(users));
            alert("Password updated successfully!");
        } else {
            alert("Current password is incorrect.");
        }
    }
    // Save other profile data
    const onboardingData = JSON.parse(localStorage.getItem('auraOnboarding')) || {};
    onboardingData[userEmail] = { ...onboardingData[userEmail], ...editedProfile };
    localStorage.setItem('auraOnboarding', JSON.stringify(onboardingData));
    
    setCurrentPassword("");
    setNewPassword("");
    setIsEditingProfile(false);
  };

  function handleShareStory() {
    if (!newStoryText.trim()) {
        alert("Please write your story before sharing.");
        return;
    }
    setPeerStories(prev => [{ id: Date.now(), text: newStoryText.trim() }, ...prev]);
    setNewStoryText("");
    setIsSharingStory(false);
  }


  function suggestedActivity(m) {
    switch (m) {
      case "Anxious": return "I hear anxiety. Try a 3-3-3 grounding exercise: name 3 things you see, 3 you can touch, and take 3 deep breaths. Want to try?";
      case "Sad": return "I'm sorry youâ€™re feeling sad. Would a gentle journaling prompt or a mood-boost playlist help?";
      case "Stressed": return "Stress can feel heavy. A 2-minute box breathing session may help. Want to try it now?";
      case "Okay": return "Nice. Letâ€™s keep that going with a quick micro-habit: 5 minutes of stretching or a gratitude note.";
      default: return "Thanks for sharing. I'm here for you.";
    }
  }

  function quickMood(selected) {
    setChat((c) => [...c, { id: Date.now() + Math.random(), from: "user", text: `I'm feeling ${selected}.` }, { id: Date.now() + Math.random(), from: "bot", text: suggestedActivity(selected) }, ]);
    setMoodHistory((prev) => [...prev.slice(-5), { day: `Day ${prev.length + 1}`, mood: moodScore(selected) }]);
    setScreen('chat');
  }

  function moodScore(m) {
    return { "Sad": 1, "Anxious": 2, "Stressed": 3, "Okay": 4 }[m] || 2;
  }

  function addJournal() {
    if (!newJournal.trim()) return;
    setJournalEntries((prev) => [...prev, { id: Date.now(), text: newJournal.trim() }]);
    setNewJournal("");
    setJournalInsight(null);
    setAchievements((prev) => prev.map((a) => (a.id === 3 ? { ...a, earned: true } : a)));
  }

  function toggleHabit(id) {
    setHabits((prev) => prev.map((h) => (h.id === id ? { ...h, completed: !h.completed } : h)));
  }

  const moodLabels = ["", "Sad", "Anxious", "Stressed", "Okay"];
  const mainNavItems = [
    { id: 'chat', label: 'Chat' }, { id: 'moodHistory', label: 'Mood Insights' }, { id: 'journal', label: 'Journal' }, { id: 'habits', label: 'Habits' }, { id: 'achievements', label: 'Achievements' }, { id: 'stories', label: 'Peer Stories' }, { id: 'suggestions', label: 'Feedback & Suggestions' }, { id: 'youthHelp', label: 'Youth Help'}, { id: 'resources', label: 'Resources' },
  ];
  const secondaryNavItems = [
    { id: 'profile', label: 'Profile' }, { id: 'settings', label: 'Settings' }, { id: 'about', label: 'About Aura' },
  ];

  const getMostFrequentMood = () => {
    if (moodHistory.length === 0) return "Not recorded";
    const moodCounts = moodHistory.reduce((acc, entry) => {
        const moodLabel = moodLabels[entry.mood];
        if (moodLabel) {
            acc[moodLabel] = (acc[moodLabel] || 0) + 1;
        }
        return acc;
    }, {});
    if (Object.keys(moodCounts).length === 0) return "Not recorded";
    return Object.keys(moodCounts).reduce((a, b) => moodCounts[a] > moodCounts[b] ? a : b);
  };

  const renderContent = () => {
    switch (screen) {
      case null: return (<div className="p-6 h-full flex flex-col justify-center items-center text-center"><h2 className="text-3xl font-semibold text-gray-800">Welcome to Aura</h2><p className="text-gray-600 mt-2 max-w-md">How are you feeling today? Select a mood or an activity from the left to get started.</p></div>);
      case 'chat': return (
        <div className="bg-white/10 backdrop-blur-lg rounded-2xl shadow-lg h-full flex flex-col">
            {/* Chat Header */}
            <div className="flex items-center p-4 border-b border-white/10">
                <div className="w-10 h-10 rounded-full flex items-center justify-center bg-indigo-400 shrink-0">
                   <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 text-white"><path d="M12 2L14.09 8.26L20 9.27L15.54 13.97L16.91 20L12 17.27L7.09 20L8.46 13.97L4 9.27L9.91 8.26L12 2z"/></svg>
                </div>
                <div className="ml-3">
                    <h3 className="font-semibold text-white">Aura</h3>
                    <p className="text-sm text-indigo-200">Online</p>
                </div>
            </div>

            {/* Chat Messages */}
            <div className="flex-1 overflow-auto p-4 space-y-4">
              {chat.map((m) => {
                const isUser = m.from !== 'bot';
                return (
                    <motion.div 
                        key={m.id} 
                        className={`w-full flex items-end gap-2 max-w-[80%] ${isUser ? 'ml-auto flex-row-reverse' : ''}`}
                        initial={{ opacity: 0, y: 10 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ duration: 0.3 }}
                    >
                        <div className={`w-8 h-8 rounded-full flex items-center justify-center ${isUser ? 'bg-pink-400' : 'bg-indigo-400'} shrink-0`}>
                            {isUser ? 'Y' : <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5 text-white"><path d="M12 2L14.09 8.26L20 9.27L15.54 13.97L16.91 20L12 17.27L7.09 20L8.46 13.97L4 9.27L9.91 8.26L12 2z"/></svg>}
                        </div>
                        <div className={`${isUser ? 'bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-t-2xl rounded-bl-lg' : 'bg-white text-gray-800 rounded-t-2xl rounded-br-lg'} p-3 shadow-md`}>
                            <p className="text-sm">{m.text}</p>
                        </div>
                    </motion.div>
                );
              })}
              {isThinking && <div className="flex items-end gap-2 max-w-[80%] justify-start"><div className="w-8 h-8 rounded-full flex items-center justify-center text-white bg-indigo-400">...</div><div className="bg-white p-3 rounded-lg shadow-sm text-sm">Aura is typing...</div></div>}
              <div ref={chatEndRef} />
            </div>

            {/* Chat Input */}
            <div className="p-4 flex gap-3 border-t border-white/10 items-center">
              <button
                onClick={handleToggleListening}
                className={`w-12 h-12 flex items-center justify-center rounded-full transition-colors shrink-0 ${isListening ? 'bg-red-500 text-white animate-pulse' : 'bg-indigo-500 text-white hover:bg-indigo-600'}`}
                disabled={!recognitionRef.current}
              >
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg>
              </button>
              <textarea value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), sendMessage())} placeholder={isListening ? "Listening..." : "Type or speak your message..."} className="flex-1 p-3 border border-white/20 bg-white/5 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-indigo-500 transition resize-none" rows={1} disabled={isThinking}/>
              <button onClick={sendMessage} className="w-12 h-12 flex items-center justify-center bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-colors disabled:opacity-50 shrink-0" disabled={isThinking || !input.trim()}>
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
              </button>
            </div>
          </div>
        );
      case 'profile': return (
        <div className="bg-white/10 backdrop-blur-lg rounded-2xl shadow-lg p-6 text-indigo-100 h-full overflow-y-auto">
            <div className="flex justify-between items-center">
                <div>
                    <h2 className="font-semibold text-2xl text-white">Your Profile</h2>
                    <p className="text-indigo-200 mt-1">View and edit your profile details.</p>
                </div>
                {!isEditingProfile && (
                    <button onClick={handleProfileEdit} className="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition">
                        Edit Profile
                    </button>
                )}
            </div>

            <div className="mt-6 p-6 bg-black/20 rounded-lg">
                <div className="flex items-center gap-6">
                    <input type="file" ref={fileInputRef} onChange={handlePhotoUpload} style={{ display: 'none' }} accept="image/*" />
                     <div className="relative group cursor-pointer" onClick={() => fileInputRef.current.click()}>
                        <div className="w-24 h-24 bg-black/30 rounded-full flex items-center justify-center border-2 border-indigo-400/50">
                            {profilePhoto ? (
                                <img src={profilePhoto} alt="Profile" className="w-full h-full rounded-full object-cover" />
                            ) : (
                                <span className="text-4xl text-indigo-300">ðŸ‘¤</span>
                            )}
                        </div>
                        <div className="absolute inset-0 bg-black/60 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <span className="text-white text-xs text-center">Change Photo</span>
                        </div>
                    </div>
                    <div>
                        <h3 className="text-xl font-bold text-white">{profileData.name}</h3>
                        <p className="text-indigo-200">Member Since: Sep 2025</p>
                    </div>
                </div>

                {isEditingProfile && (
                    <div className="mt-6 pt-6 border-t border-indigo-500/50">
                        <div className="space-y-4">
                            <div>
                                <label className="text-sm text-indigo-300">Name</label>
                                <input type="text" value={editedProfile.name} onChange={(e) => setEditedProfile({...editedProfile, name: e.target.value})} className="w-full mt-1 p-2 bg-black/30 border border-indigo-500/50 rounded-lg text-white" />
                            </div>
                             <div>
                                <label className="text-sm text-indigo-300">Phone</label>
                                <input type="text" value={editedProfile.phone} onChange={(e) => setEditedProfile({...editedProfile, phone: e.target.value})} className="w-full mt-1 p-2 bg-black/30 border border-indigo-500/50 rounded-lg text-white" />
                            </div>
                            <div>
                                <label className="text-sm text-indigo-300">Address</label>
                                <input type="text" value={editedProfile.address} onChange={(e) => setEditedProfile({...editedProfile, address: e.target.value})} className="w-full mt-1 p-2 bg-black/30 border border-indigo-500/50 rounded-lg text-white" />
                            </div>

                            <h3 className="font-semibold text-lg text-white pt-4">Change Password</h3>
                            <div>
                                <label className="text-sm text-indigo-300">Current Password</label>
                                <input type="password" value={currentPassword} onChange={(e) => setCurrentPassword(e.target.value)} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" className="w-full mt-1 p-2 bg-black/30 border border-indigo-500/50 rounded-lg text-white" />
                            </div>
                            <div>
                                <label className="text-sm text-indigo-300">New Password</label>
                                <input type="password" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" className="w-full mt-1 p-2 bg-black/30 border border-indigo-500/50 rounded-lg text-white" />
                            </div>
                        </div>
                    </div>
                )}
            </div>
            
            {!isEditingProfile && (
                <div className="mt-4 p-6 bg-black/20 rounded-lg">
                    <h3 className="font-semibold text-lg text-white border-b border-indigo-500/50 pb-2 mb-3">Your Details</h3>
                    <div className="grid grid-cols-2 gap-4">
                        <div><p className="text-indigo-300 text-sm">Age</p><p className="font-semibold">{profileData.age}</p></div>
                        <div><p className="text-indigo-300 text-sm">Gender</p><p className="font-semibold">{profileData.gender}</p></div>
                        <div><p className="text-indigo-300 text-sm">Phone</p><p className="font-semibold">{profileData.phone || 'Not provided'}</p></div>
                        <div className="col-span-2"><p className="text-indigo-300 text-sm">Address</p><p className="font-semibold">{profileData.address || 'Not provided'}</p></div>
                    </div>
                </div>
            )}

            {isEditingProfile && (
                <div className="mt-4 flex gap-4">
                    <button onClick={handleProfileSave} className="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">Save Changes</button>
                    <button onClick={handleProfileCancel} className="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">Cancel</button>
                </div>
            )}
            
            <div className={`mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 ${isEditingProfile ? 'opacity-20' : ''}`}>
                 <div className="p-6 bg-black/20 rounded-lg flex flex-col items-center justify-center text-center">
                    <h3 className="font-semibold text-lg text-white">Current Streak</h3>
                    <p className="text-5xl font-bold my-2">{streak} <span className="text-3xl">ðŸ”¥</span></p>
                    <p className="text-indigo-200 text-sm">days</p>
                </div>
                <div className="md:col-span-2 p-6 bg-black/20 rounded-lg">
                     <h3 className="font-semibold text-lg text-white border-b border-indigo-500/50 pb-2 mb-3">Your Progress</h3>
                     <div className="grid grid-cols-2 gap-4 mt-4">
                        <div><p className="text-indigo-300 text-sm">Achievements</p><p className="text-2xl font-semibold">{achievements.filter(a => a.earned).length} / {achievements.length}</p></div>
                        <div><p className="text-indigo-300 text-sm">Journal Entries</p><p className="text-2xl font-semibold">{journalEntries.length}</p></div>
                        <div><p className="text-indigo-300 text-sm">Habits Completed</p><p className="text-2xl font-semibold">{habits.filter(h => h.completed).length}</p></div>
                        <div><p className="text-indigo-300 text-sm">Common Mood</p><p className="text-2xl font-semibold">{getMostFrequentMood()}</p></div>
                     </div>
                </div>
            </div>
          </div>
      );
      case 'settings': return (
            <div className="bg-white/10 backdrop-blur-lg rounded-2xl shadow-lg h-full p-6 text-indigo-100 overflow-y-auto"><h2 className="font-semibold text-2xl text-white">Settings</h2><p className="text-indigo-200 mt-1">Customize your Aura experience.</p><div className="mt-6 space-y-6"><div className="p-6 bg-black/20 rounded-lg"><h3 className="font-semibold text-xl mb-4 border-b border-indigo-400/50 pb-2 text-white">General</h3><div className="space-y-4"><div className="flex items-center justify-between"><label htmlFor="notifications" className="font-medium text-indigo-100">Push Notifications</label><input type="checkbox" id="notifications" className="h-6 w-6 rounded text-indigo-600 focus:ring-indigo-500" defaultChecked /></div><div className="flex items-center justify-between"><label htmlFor="theme" className="font-medium text-indigo-100">Theme</label><select id="theme" className="p-2 border border-white/20 bg-black/30 rounded-lg text-white"><option>Light</option><option disabled>Dark (coming soon)</option></select></div><div className="flex items-center justify-between"><label htmlFor="reminder" className="font-medium text-indigo-100">Daily Check-in Reminder</label><input type="time" id="reminder" className="p-2 border border-white/20 bg-black/30 rounded-lg text-white" defaultValue="19:00" /></div></div></div><div className="p-6 bg-black/20 rounded-lg"><h3 className="font-semibold text-xl mb-4 border-b border-indigo-400/50 pb-2 text-white">Data & Privacy</h3><div className="space-y-4"><div className="flex items-center justify-between"><p className="font-medium text-indigo-100">Clear Chat History</p><button onClick={() => alert('Chat history cleared! (prototype)')} className="px-4 py-2 text-sm bg-yellow-400 text-yellow-900 rounded-lg hover:bg-yellow-500 transition">Clear</button></div><div className="flex items-center justify-between"><p className="font-medium text-indigo-100">Export Journal Data</p><button onClick={() => alert('Journal data exported! (prototype)')} className="px-4 py-2 text-sm bg-blue-400 text-blue-900 rounded-lg hover:bg-blue-500 transition">Export</button></div></div></div><div className="p-6 bg-black/20 rounded-lg"><h3 className="font-semibold text-xl mb-4 border-b border-indigo-400/50 pb-2 text-white">Account</h3><div className="space-y-4"><button onClick={() => window.location.reload()} className="w-full px-4 py-2 bg-indigo-200 text-indigo-900 rounded-lg hover:bg-indigo-300 transition">Log Out</button><button onClick={() => alert('Account deleted! (prototype)')} className="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">Delete Account</button></div></div></div></div>);
      case 'about': return (
        <div className="bg-white/10 backdrop-blur-lg rounded-2xl shadow-lg p-6 text-indigo-100 h-full overflow-y-auto">
            <h2 className="font-semibold text-2xl text-white">About Aura</h2>
            <p className="text-indigo-200 mt-1">Your confidential wellness companion.</p>
    
            <div className="mt-6 space-y-6 text-indigo-200">
                {/* Our Mission */}
                <div className="p-4 bg-black/20 rounded-lg">
                    <h3 className="font-semibold text-lg text-white mb-2">Our Mission</h3>
                    <p>Aura's mission is to provide an accessible, stigma-free space for young people to proactively manage their mental wellness. We believe that small, consistent steps can lead to significant positive change, and everyone deserves a supportive companion for their journey.</p>
                </div>
    
                {/* How It Works */}
                <div className="p-4 bg-black/20 rounded-lg">
                    <h3 className="font-semibold text-lg text-white mb-2">How It Works</h3>
                    <p>Aura combines several tools to support you:</p>
                    <ul className="list-disc list-inside mt-2 space-y-1 pl-2">
                        <li><strong>AI Chat:</strong> Talk about what's on your mind and get supportive, contextual responses.</li>
                        <li><strong>Journaling:</strong> Reflect on your thoughts and feelings with AI-powered insights and prompts.</li>
                        <li><strong>Habit Tracking:</strong> Build small, positive habits that contribute to your overall well-being.</li>
                        <li><strong>Mood Insights:</strong> Track your mood over time to better understand your emotional patterns.</li>
                    </ul>
                </div>
    
                {/* Privacy & Safety */}
                <div className="p-4 bg-black/20 rounded-lg">
                    <h3 className="font-semibold text-lg text-white mb-2">Privacy & Safety</h3>
                    <p>Your privacy is our top priority. Conversations and journal entries are handled with confidentiality in mind. While our AI chat is designed to be a safe space, in cases of crisis, it is programmed to guide you towards immediate, real-world help. Your data is used to personalize your experience and is not shared.</p>
                </div>
    
                {/* Disclaimer */}
                <div className="p-4 bg-black/20 rounded-lg border border-yellow-500/50">
                    <h3 className="font-semibold text-lg text-yellow-300 mb-2">Important Disclaimer</h3>
                    <p className="text-yellow-200">Aura is a wellness tool, not a medical device. It is not a replacement for professional therapy or medical advice from a qualified healthcare provider. If you are in crisis, please contact a local emergency service or a crisis hotline immediately.</p>
                </div>
                
                 <p className="text-center text-sm text-indigo-400 pt-4">Version: 1.0.0 (Prototype)</p>
            </div>
        </div>
    );
      case 'youthHelp': return (
        <div className="bg-white/10 backdrop-blur-lg rounded-2xl shadow-lg p-6 text-indigo-100 h-full overflow-y-auto">
            <h2 className="font-semibold text-2xl text-white">Youth Help & Emergency</h2>
            <p className="text-indigo-200 mt-1">If you are in immediate danger, please call emergency services.</p>
            <div className="mt-6 space-y-6">
                <div className="p-4 bg-black/20 rounded-lg">
                    <h3 className="font-semibold text-lg text-white mb-2">National Youth Helpline</h3>
                    <a href="tel:1098" className="flex items-center gap-4 p-4 bg-indigo-500/20 rounded-lg hover:bg-indigo-500/30 transition">
                        <span className="text-3xl">ðŸ“ž</span>
                        <div>
                            <p className="font-bold text-2xl text-white">1098</p>
                            <p className="text-indigo-200">Childline India Foundation</p>
                        </div>
                    </a>
                </div>
                <div className="p-4 bg-black/20 rounded-lg">
                     <h3 className="font-semibold text-lg text-white mb-2">Emergency Services</h3>
                     <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <a href="tel:112" className="p-3 bg-red-500/20 rounded-lg text-center hover:bg-red-500/30 transition"><p className="font-semibold text-red-200">Police</p><p className="text-xl font-bold text-white">112 or 100</p></a>
                        <a href="tel:108" className="p-3 bg-blue-500/20 rounded-lg text-center hover:bg-blue-500/30 transition"><p className="font-semibold text-blue-200">Ambulance</p><p className="text-xl font-bold text-white">108 or 102</p></a>
                        <a href="tel:101" className="p-3 bg-orange-500/20 rounded-lg text-center hover:bg-orange-500/30 transition"><p className="font-semibold text-orange-200">Fire</p><p className="text-xl font-bold text-white">101</p></a>
                     </div>
                </div>
                 <div className="p-4 bg-black/20 rounded-lg">
                    <h3 className="font-semibold text-lg text-white mb-2">Find Nearby Help</h3>
                    <a href="https://www.google.com/maps/search/nearby+police+station" target="_blank" rel="noopener noreferrer" className="block w-full text-center p-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Find Nearby Police Station
                    </a>
                 </div>
            </div>
        </div>
      );
      case 'resources': return (
        <div className="bg-white/10 backdrop-blur-lg rounded-2xl shadow-lg p-6 text-indigo-100 h-full overflow-y-auto">
            <h2 className="font-semibold text-2xl text-white">Help & Resources</h2>
            <p className="text-indigo-200 mt-1">You are not alone. Confidential help is available.</p>
            <div className="mt-6 space-y-6">
                <div>
                    <h3 className="font-semibold text-lg text-white border-b border-indigo-500/50 pb-2 mb-3">Immediate Help (24/7 Hotlines)</h3>
                    <div className="space-y-3">
                        <div className="p-4 bg-black/20 rounded-lg">
                            <p className="font-semibold text-indigo-200">Crisis Text Line</p>
                            <p className="text-sm text-indigo-300 mt-1">Text HOME to 741741 from anywhere in the US, anytime, about any type of crisis.</p>
                            <a href="#" className="text-sm text-cyan-400 hover:underline">Visit Website</a>
                        </div>
                        <div className="p-4 bg-black/20 rounded-lg">
                            <p className="font-semibold text-indigo-200">The Trevor Project</p>
                            <p className="text-sm text-indigo-300 mt-1">For LGBTQ young people in crisis, feeling suicidal, or in need of a safe and judgment-free place to talk. Call 1-866-488-7386.</p>
                             <a href="#" className="text-sm text-cyan-400 hover:underline">Visit Website</a>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 className="font-semibold text-lg text-white border-b border-indigo-500/50 pb-2 mb-3">Professional Support</h3>
                     <div className="space-y-3">
                        <div className="p-4 bg-black/20 rounded-lg">
                            <p className="font-semibold text-indigo-200">National Alliance on Mental Illness (NAMI)</p>
                            <p className="text-sm text-indigo-300 mt-1">Offers resources, support groups, and educational programs for individuals and families affected by mental illness.</p>
                            <a href="#" className="text-sm text-cyan-400 hover:underline">Find Local NAMI</a>
                        </div>
                    </div>
                </div>
                <div>
                     <h3 className="font-semibold text-lg text-white border-b border-indigo-500/50 pb-2 mb-3">Online Communities & Articles</h3>
                     <div className="space-y-3">
                        <div className="p-4 bg-black/20 rounded-lg">
                            <p className="font-semibold text-indigo-200">Headspace: Articles</p>
                            <p className="text-sm text-indigo-300 mt-1">A collection of articles on meditation, mindfulness, and mental health topics.</p>
                            <a href="#" className="text-sm text-cyan-400 hover:underline">Read Articles</a>
                        </div>
                         <div className="p-4 bg-black/20 rounded-lg">
                            <p className="font-semibold text-indigo-200">7 Cups</p>
                            <p className="text-sm text-indigo-300 mt-1">Connect with trained volunteer listeners and online therapists in a confidential setting.</p>
                             <a href="#" className="text-sm text-cyan-400 hover:underline">Visit Website</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
      case 'journal': return (
          <div className="bg-white/10 backdrop-blur-lg rounded-2xl shadow-lg p-6 text-indigo-100 h-full flex flex-col">
            <h2 className="font-semibold text-2xl text-white">Wellness Journal</h2>
            <p className="text-indigo-200 mt-1">Reflect privately. Your entries are not sent to the server.</p>
            <div className="flex gap-4 mt-4">
                <button onClick={generateJournalPrompt} disabled={isGeneratingPrompt} className="flex-1 text-sm px-3 py-2 bg-indigo-200 text-indigo-800 rounded-md hover:bg-indigo-300 transition disabled:opacity-50">
                    âœ¨ {isGeneratingPrompt ? 'Thinking...' : 'Get a new prompt'}
                </button>
            </div>
            <textarea value={newJournal} onChange={(e) => setNewJournal(e.target.value)} placeholder="Write your thoughts here, or ask for a prompt to get started..." className="w-full p-3 border border-white/20 bg-white/5 rounded-lg mt-4 text-white placeholder-gray-400 flex-grow" />
            <button onClick={addJournal} className="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Save Entry</button>
            <div className="mt-6 flex-1 overflow-y-auto"><h3 className="font-semibold text-lg text-white mb-2">Past Entries</h3>
                <div className="space-y-3">
                    {journalEntries.length === 0 ? <p className="text-gray-400 text-sm">No entries yet.</p> : journalEntries.map((j, index) => (<div key={j.id} className="p-3 border rounded-lg bg-black/20 text-indigo-200 text-sm"><p className="whitespace-pre-wrap">{j.text}</p>{index === journalEntries.length - 1 && (<div className="mt-3"><button onClick={getJournalInsights} disabled={isAnalyzing} className="text-sm px-3 py-1 bg-indigo-200 text-indigo-800 rounded-md hover:bg-indigo-300 transition disabled:opacity-50">âœ¨ {isAnalyzing ? 'Analyzing...' : 'Analyze my Entry'}</button>{journalInsight && (<div className="mt-3 p-3 bg-black/20 rounded-lg text-indigo-200 border border-indigo-400/50"><p className="whitespace-pre-wrap">{journalInsight}</p></div>)}</div>)}</div>))}
                </div>
            </div>
          </div>
      );
      case 'stories': return (
        <div className="bg-white/10 backdrop-blur-lg rounded-2xl shadow-lg p-6 text-indigo-100 h-full flex flex-col">
            <div className="flex justify-between items-center mb-4">
                <div>
                    <h2 className="font-semibold text-2xl text-white">Peer Stories</h2>
                    <p className="text-indigo-200 mt-1">Anonymous, stigma-busting stories from other youth.</p>
                </div>
                <button onClick={() => setIsSharingStory(true)} className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                    Share Your Story
                </button>
            </div>
    
            <div className="flex gap-4 mb-4">
                <button onClick={generatePeerStory} disabled={isGeneratingStory} className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50">
                    âœ¨ {isGeneratingStory ? 'Generating...' : 'Generate a New Story'}
                </button>
            </div>
    
            <div className="space-y-4 overflow-y-auto">
                {peerStories.map(story => (
                    <div key={story.id} className="p-4 bg-black/20 rounded-lg animate-fade-in">
                        <p className="text-indigo-200">"{story.text}"</p>
                        <p className="text-right text-sm text-indigo-400 mt-2">- Anonymous</p>
                    </div>
                ))}
            </div>
        </div>
    );
      case 'achievements': return (
        <div className="bg-white/10 backdrop-blur-lg rounded-2xl shadow-lg p-6 text-indigo-100 h-full overflow-y-auto">
            <h2 className="font-semibold text-2xl text-white">Your Achievements</h2>
            <p className="text-indigo-200 mt-1">Celebrate your progress, every step counts!</p>
            <div className="mt-6 space-y-6">
                {Object.entries(achievements.reduce((acc, a) => {
                    if (!acc[a.category]) acc[a.category] = [];
                    acc[a.category].push(a);
                    return acc;
                }, {})).map(([category, items]) => (
                    <div key={category}>
                        <h3 className="font-semibold text-lg text-white border-b border-indigo-500/50 pb-2 mb-3">{category}</h3>
                        <div className="space-y-3">
                            {items.map(a => (
                                <div key={a.id} className={`p-4 rounded-lg flex items-start gap-4 transition-all ${a.earned ? 'bg-green-500/20 border border-green-500/30' : 'bg-black/20'}`}>
                                    <span className={`text-2xl ${a.earned ? 'opacity-100' : 'opacity-30'}`}>{a.earned ? 'ðŸ†' : 'ðŸ”’'}</span>
                                    <div>
                                        <h4 className={`font-semibold ${a.earned ? 'text-green-200' : 'text-indigo-200'}`}>{a.title}</h4>
                                        <p className="text-sm text-indigo-300">{a.description}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
      case 'habits': return (
        <div className="bg-white/10 backdrop-blur-lg rounded-2xl shadow-lg p-6 text-indigo-100 h-full flex flex-col">
            <h2 className="font-semibold text-2xl text-white">Habit Tracker</h2>
            <p className="text-indigo-200 mt-1">Build small daily habits that support your wellness.</p>

            <div className="mt-4">
                <p className="text-sm text-indigo-300">Daily Progress</p>
                <div className="w-full bg-black/30 rounded-full h-2.5 mt-1">
                    <div className="bg-green-500 h-2.5 rounded-full" style={{ width: `${(habits.filter(h => h.completed).length / habits.length) * 100}%` }}></div>
                </div>
            </div>

            <div className="mt-6">
                <h3 className="font-semibold text-lg text-white">To-Do</h3>
                <ul className="mt-2 space-y-2">
                    {habits.filter(h => !h.completed).map(h => (
                        <li key={h.id} className="flex items-center gap-3 p-3 rounded-lg bg-black/20">
                            <input type="checkbox" checked={h.completed} onChange={() => toggleHabit(h.id)} className="h-5 w-5 rounded text-indigo-400 bg-transparent border-indigo-400 focus:ring-indigo-500" />
                            <span>{h.name}</span>
                        </li>
                    ))}
                </ul>
            </div>

             <div className="mt-6">
                <h3 className="font-semibold text-lg text-white">Completed</h3>
                <ul className="mt-2 space-y-2">
                    {habits.filter(h => h.completed).map(h => (
                        <li key={h.id} className="flex items-center gap-3 p-3 rounded-lg bg-black/20 opacity-60">
                            <input type="checkbox" checked={h.completed} onChange={() => toggleHabit(h.id)} className="h-5 w-5 rounded text-indigo-400 bg-transparent border-indigo-400 focus:ring-indigo-500" />
                            <span className='line-through'>{h.name}</span>
                        </li>
                    ))}
                </ul>
            </div>
            
            <div className="mt-auto pt-4">
                <button onClick={suggestNewHabit} disabled={isSuggestingHabit} className="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50">
                    âœ¨ {isSuggestingHabit ? 'Thinking...' : 'Suggest a New Habit'}
                </button>
            </div>
          </div>
      );
      case 'moodHistory': return (
            <div className="bg-white/10 backdrop-blur-lg rounded-2xl shadow-lg p-6 text-indigo-100 h-full overflow-y-auto">
                <h2 className="font-semibold text-2xl text-white">Mood Insights</h2>
                <p className="text-indigo-200 mt-1">See your mood patterns over the last few days.</p>
                <div className="mt-6 p-4 bg-black/20 rounded-lg shadow-sm" style={{ width: '100%', height: 300 }}>
                    <ResponsiveContainer><LineChart data={moodHistory} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}><Line type="monotone" dataKey="mood" stroke="#818cf8" strokeWidth={2} /><CartesianGrid stroke="#ffffff20" strokeDasharray="5 5" /><XAxis dataKey="day" stroke="#a5b4fc" /><YAxis domain={[0, 5]} ticks={[1,2,3,4]} tickFormatter={(v) => moodLabels[v] || ''} stroke="#a5b4fc" /><Tooltip contentStyle={{ background: "rgba(30, 41, 59, 0.8)", border: "1px solid #4f46e5", color: "white" }} /></LineChart></ResponsiveContainer>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                    <div className="p-4 bg-black/20 rounded-lg text-center"><p className="text-sm text-indigo-300">Common Mood</p><p className="text-xl font-bold">{getMostFrequentMood()}</p></div>
                    <div className="p-4 bg-black/20 rounded-lg text-center"><p className="text-sm text-indigo-300">Longest Streak</p><p className="text-xl font-bold">{streak} Days</p></div>
                    <div className="p-4 bg-black/20 rounded-lg text-center"><p className="text-sm text-indigo-300">Weekly Summary</p><p className="text-xl font-bold">Stable</p></div>
                </div>
                <div className="mt-6 text-center"><button onClick={analyzeMoodTrend} disabled={isAnalyzingTrend} className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50">âœ¨ {isAnalyzingTrend ? 'Analyzing...' : 'Get AI Analysis'}</button>{moodTrendAnalysis && (<div className="mt-4 p-4 bg-black/20 rounded-lg text-indigo-200 border border-indigo-400/50"><p className="whitespace-pre-wrap">{moodTrendAnalysis}</p></div>)}</div>
            </div>
        );
      case 'suggestions': return (
        <div className="bg-white/10 backdrop-blur-lg rounded-2xl shadow-lg p-6 text-indigo-100 h-full flex flex-col">
            {/* Part 1: Personalized Suggestions FOR the user */}
            <div>
                <h2 className="font-semibold text-2xl text-white">Personalized Suggestions</h2>
                <p className="text-indigo-200 mt-1">Tips from Aura based on your recent activity.</p>
                <div className="text-center my-4">
                    <button onClick={getSuggestions} disabled={isGettingSuggestions} className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 text-base">
                        âœ¨ {isGettingSuggestions ? 'Generating...' : 'Get New Suggestions'}
                    </button>
                </div>
                {isGettingSuggestions ? (
                    <div className="flex justify-center items-center h-24"><p>Aura is thinking...</p></div>
                ) : (
                    <div className="space-y-3">
                        {suggestions.length > 0 ? suggestions.map((s, i) => (
                            <div key={i} className="p-4 bg-black/20 rounded-lg flex items-start gap-4">
                                <span className="text-2xl">{s.icon}</span>
                                <p>{s.suggestion}</p>
                            </div>
                        )) : <p className="text-center text-indigo-200 text-sm">Click the button to get your first set of suggestions!</p>}
                    </div>
                )}
            </div>

            <div className="my-6 border-t border-indigo-500/50"></div>

            {/* Part 2: Feedback FROM the user */}
            <div className="flex flex-col flex-grow">
                <h2 className="font-semibold text-2xl text-white">Share Your Feedback</h2>
                {feedbackSent ? (
                    <div className="mt-4 p-4 bg-green-500/30 text-green-200 rounded-lg text-center flex-grow flex items-center justify-center">
                        <div>
                            <p className="font-semibold">Thank You For your Feedback !</p>
                            <p className="text-sm">We will definetly work on it !</p>
                        </div>
                    </div>
                ) : (
                    <>
                        <p className="text-indigo-200 mt-1">Have a suggestion to improve Aura? Let us know!</p>
                        <textarea
                            value={feedbackText}
                            onChange={(e) => setFeedbackText(e.target.value)}
                            placeholder="Type your suggestions here..."
                            className="w-full p-3 border border-white/20 bg-white/5 rounded-lg mt-4 text-white placeholder-gray-400 flex-grow"
                        />
                        <button
                            onClick={handleSendFeedback}
                            className="mt-4 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition"
                        >
                            Send Feedback
                        </button>
                    </>
                )}
            </div>
          </div>
      );
      default: return null;
    }
  };

  return (
    <div className="relative min-h-screen bg-gradient-to-br from-gray-900 to-indigo-900 overflow-hidden flex items-center justify-center p-4 font-sans">
      <Orb className="w-96 h-96 bg-indigo-500" initial={{ x: -100, y: -150 }} animate={{ x: 100, y: 150 }} />
      <Orb className="w-80 h-80 bg-pink-500" initial={{ x: 200, y: 150 }} animate={{ x: -50, y: -200 }} />
      <Orb className="w-72 h-72 bg-purple-500" initial={{ x: -200, y: 200 }} animate={{ x: 50, y: -100 }} />
      
      <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.6 }} className="w-full max-w-7xl h-[90vh] bg-black/20 backdrop-blur-xl rounded-2xl shadow-xl grid grid-cols-12 overflow-hidden">
        <div className="col-span-12 md:col-span-3 bg-indigo-700/80 text-white p-6 flex flex-col overflow-y-auto">
          <div><h1 className="text-4xl font-bold">Aura</h1><p className="mt-2 text-indigo-200">Your confidential wellness companion</p></div>
          <div className="mt-8"><h3 className="font-semibold text-indigo-200">Daily Streak</h3><p className="text-3xl mt-1 text-white">ðŸ”¥ {streak} days</p></div>
          <div className="mt-8"><h3 className="font-semibold text-indigo-200">Quick Mood Check</h3><div className="mt-3 grid grid-cols-2 gap-2">{["Anxious", "Sad", "Stressed", "Okay"].map((m) => (<button key={m} onClick={() => quickMood(m)} className="bg-indigo-500/80 hover:bg-indigo-500 rounded-md py-2 text-sm transition-colors">{m}</button>))}</div></div>
          <nav className="mt-auto flex flex-col gap-2">{mainNavItems.map(item => (<button key={item.id} onClick={() => setScreen(item.id)} className={`w-full text-left px-4 py-2 rounded-lg font-medium transition-colors ${screen === item.id ? 'bg-white text-indigo-700 shadow' : 'bg-indigo-600 hover:bg-indigo-500/80'}`}>{item.label}</button>))}<div className="my-2 border-t border-indigo-500"></div>{secondaryNavItems.map(item => (<button key={item.id} onClick={() => setScreen(item.id)} className={`w-full text-left px-4 py-2 rounded-lg font-medium transition-colors ${screen === item.id ? 'bg-white text-indigo-700 shadow' : 'bg-indigo-600 hover:bg-indigo-500/80'}`}>{item.label}</button>))}</nav>
        </div>
        <div className="col-span-12 md:col-span-9 p-6 overflow-y-auto">{renderContent()}</div>
        {escalationOpen && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"><motion.div initial={{scale: 0.9, opacity: 0}} animate={{scale: 1, opacity: 1}} className="bg-white rounded-lg p-6 max-w-md w-full shadow-xl"><h3 className="text-xl font-semibold text-gray-800">We want to keep you safe</h3>{isConnecting ? (<p className="mt-4 text-gray-600">Connecting you to the crisis helpline...</p>) : (<><p className="mt-2 text-gray-600">Your message is concerning. Can we connect you to a crisis line now?</p><div className="mt-6 flex gap-3 justify-end"><button onClick={() => { setIsConnecting(true); setTimeout(() => { setEscalationOpen(false); setIsConnecting(false); }, 3000); }} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Yes, Connect</button><button onClick={() => { setEscalationOpen(false); setChat((c) => [...c, { id: Date.now(), from: 'bot', text: "Okay. Please know help is available. I can offer grounding activities or show you other resources." }]); }} className="px-4 py-2 border rounded-lg hover:bg-gray-100 transition">Not now</button></div></>)}</motion.div></div>)}
        {isSharingStory && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <motion.div initial={{scale: 0.9, opacity: 0}} animate={{scale: 1, opacity: 1}} className="bg-gray-800 text-white rounded-lg p-6 max-w-lg w-full shadow-xl">
                    <h3 className="text-xl font-semibold">Share Your Story</h3>
                    <p className="text-indigo-200 mt-2 text-sm">Your story will be shared anonymously to help and inspire others. Thank you for your courage.</p>
                    <textarea
                        value={newStoryText}
                        onChange={(e) => setNewStoryText(e.target.value)}
                        placeholder="Write your story here..."
                        className="w-full p-3 border border-indigo-500/50 bg-black/30 rounded-lg mt-4 text-white placeholder-gray-400 h-40"
                    />
                    <div className="mt-6 flex gap-3 justify-end">
                        <button onClick={handleShareStory} className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">Share Anonymously</button>
                        <button onClick={() => setIsSharingStory(false)} className="px-4 py-2 border border-indigo-400/50 rounded-lg hover:bg-indigo-500/20 transition">Cancel</button>
                    </div>
                </motion.div>
            </div>
        )}
      </motion.div>
    </div>
  );
};


// --- Main App Controller ---
export default function App() {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [userEmail, setUserEmail] = useState("");
  const [onboardingComplete, setOnboardingComplete] = useState(false);
  const [profileData, setProfileData] = useState(null);

  const handleLoginSuccess = (email) => {
    setUserEmail(email);
    setIsAuthenticated(true);
    const onboardingData = JSON.parse(localStorage.getItem('auraOnboarding')) || {};
    if (onboardingData[email] && onboardingData[email].completed) {
        setProfileData(onboardingData[email]);
        setOnboardingComplete(true);
    }
  };

  const handleOnboardingComplete = (data) => {
    setProfileData(data);
    setOnboardingComplete(true);
  };

  if (!isAuthenticated) {
    return <LoginPage onLoginSuccess={handleLoginSuccess} />;
  }
  
  if (!onboardingComplete) {
      return <OnboardingForm onOnboardingComplete={handleOnboardingComplete} userEmail={userEmail} />;
  }

  return <WellnessApp userEmail={userEmail} initialProfileData={profileData} />;
}
